#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/../common.sh"

echo "[pentest] restart manager with auth required"
docker compose -f docker-compose.dev.yml down -v || true
KUBENOVA_REQUIRE_AUTH=true docker compose -f docker-compose.dev.yml up -d --build
wait_api

echo "[pentest] GET /api/v1/tenants requires auth"
code=$(curl -sS -o /dev/null -w "%{http_code}" "$API_URL/api/v1/tenants")
test "$code" = "401"

mkdir -p artifacts
cat > artifacts/junit.xml << XML
<testsuite name="pentest" tests="1" failures="0">
  <testcase name="auth.401"/>
</testsuite>
XML

echo "[pentest] OK"
